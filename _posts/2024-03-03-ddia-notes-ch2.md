---
layout: post
title: DDIA阅读笔记(2)：数据模型与查询语言
date: 2024-03-03 +0800
tags: [系统设计, DDIA]
categories: [系统设计]
---

## 常用的数据模型

- 关系模型
- 文档模型
- 图模型

其中关系模型又称SQL，文档模型和图模型属于NoSQL。

## NoSQL的驱动因素

NoSQL全称Not Only SQL，驱动因素包括：
- 需要比关系数据库更好的可伸缩性，支持大规模数据和高写入吞吐量
- 需要比关系模型更加灵活的数据模型
- 免费和开源软件更受欢迎

## 阻抗不匹配

在面向对象的语言中使用SQL，会出现应用程序中的对象和SQL中的模型不匹配的问题，称为阻抗不匹配。需要使用ORM（object-relational mapping，对象关系映射）框架来进行转化。

## 文档模型

### 文档模型的局部性（locality）

对于自包含的数据结构，例如个人简历，如果采用关系模型，需要拆分成多个表格（如用户表、地区表、学校表、公司表等），表格之间以主键和外键进行连接，查询时需要复杂的连接操作。

如果采用文档模型，只需要用一个简单的JSON文档就可以了，只需要一次查询，性能更好。

### 文档模型的模式灵活性

关系模型是写时模式（schema-on-write），模式明确，数据库在写入数据时确保所有数据都符合其模式。

文档模型是读时模式（schema-on-read），数据库在写入数据时不做任何检查，应用程序在读取数据时做解释。

当需要修改数据格式时：
- 写时模式的数据库需要进行迁移操作，速度慢，而且要求停运。
- 读时模式的数据库只需要增加一个新字段，然后在应用程序代码中处理新旧字段的使用。

读时模式在以下场景具有优势：
- 存在许多不同类型的数据，将每种类型都定义成一个表比较麻烦
- 数据的结构由外部决定，随时会发生变化

## 数据查询语言

- 命令式查询：指定操作顺序
- 声明式查询：指定查询目标，由查询优化器决定操作顺序
  - 比命令式查询更加简介和简单
  - 隐藏了实现细节，方便数据库系统在无需修改查询的情况下做优化
  - 适合并行执行
- MapReduce查询：介于命令式和声明式之间

### MapReduce查询

MapReduce是一个Google推广的编程模型，用于在多台机器上批量处理大规模的数据。一些NoSQL（包括MongoDB和CouchDB）支持有限形式的MapReduce，用于在多个文档中执行查询操作。

以MongoDB的MapReduce功能为例：

```js
db.observations.mapReduce(
    function map() {
        var year = this.observationTimestamp.getFullYear();
        var month = this.observationTimestamp.getMonth() + 1;
        emit(year + "-" + month, this.numAnimals);
    },
    function reduce(key, values) {
        return Array.sum(values);
    },
    {
        query: {
          family: "Sharks"
        },
        out: "monthlySharkReport"
    });
```

- `query`指定过滤器
- 每个匹配的文档会执行一次`map`操作，其中`this`为文档对象，结果会发出一个键值对
- `map`发出的键值对会根据`key`来分组，对每个分组只调用一次`reduce`函数
- `out`指定输出文件

`map`和`reduce`函数的限制：必须是纯函数，只能使用输入参数，不能执行额外的数据库操作，也不能有副作用。这些限制允许数据库以任意顺序运行，并在失败时重新运行。

## 图模型

- 属性图模型
- 三元组存储模型

### 属性图模型

每个顶点（vertex）包括：
- 标识符
- 一组属性（键值对）
- 一组出边
- 一组入边

每条边（edge）包括：
- 标识符
- 一组属性（键值对）
- 边的起点（尾部顶点，tail vertex）
- 边的终点（头部顶点，head vertex）
- 描述两个顶点之间关系的标签

Cypher是属性图的声明式查询语言。

### 三元组存储模型

所有信息以`(主语，谓语，宾语)`的形式存储，其中：
- 主语：顶点
- 谓语和宾语：
  - 属性键值对，例如`(lucy, age, 33)`
  - 边和另一个顶点，例如`(lucy, marriedTo, john)`

SPARQL是三元组存储的声明式查询语言。

## 文档数据库和图数据库的适用场景

- 文档数据库：适用于自包含的数据，数据之间的关联很少
- 图数据库：适用于多对多的场景，任何数据之间都有关联
