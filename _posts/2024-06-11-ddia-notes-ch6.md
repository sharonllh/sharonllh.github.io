---
layout: post
title: DDIA阅读笔记(6)：分布式数据系统的分区
date: 2024-06-11 +0800
tags: [系统设计, DDIA]
categories: [系统设计]
---

分区（partition），也称为分片（sharding），是一种有意把大型数据库分解成小型数据库的方式，有利于提高可伸缩性。

## 分区与复制

分区与复制通常会结合使用，使每个分区的副本存储在多个节点上，提高可用性。

如下所示，一个节点可能存储多个分区，它可能充当某些分区的主库和另一些分区的从库。

![DistributedData CombinePartitionAndReplication](/assets/img/DDIA_DistributedData_CombinePartitionAndReplication.png)

## 键值数据的分区

分区的目标：把数据和查询负载均匀分布在各个节点上。

偏斜（skew）：分区不均衡，导致一些分区比别的分区有更多的数据和查询。

热点（hot spot）：分区不均衡导致的高负载的分区。

对于键值数据，有两种方法可以进行分区：

- 根据键的范围分区
- 根据键的散列分区

### 根据键的范围分区

这种方法为每个分区指定一块连续的键范围。在读写数据时，只要确定了哪个分区包含某个值，再确定分区所在的节点，就可以去相应的节点发出请求了。

为了让数据均匀分布，分区边界需要仔细选择。在常见的数据库产品中，分区边界可以由管理员手动选择，也可以由数据库自动选择。

这种方法的好处是，在每个分区中，可以按照顺序保存键，从而方便进行范围扫描。

这种方法的坏处是，某些特定的访问模式会导致热点。例如，如果主键是时间戳，每个分区是一天的数据，那么当天的数据都会写入同一个分区中。

### 根据键的散列分区

这种方法使用一个散列函数计算键的哈希值，然后为每个分区指定一个散列范围（而不是键的范围）。在读写数据时，先计算键的哈希值，就可以确定相应的分区了。

为了让数据均匀分布，需要选择一个合适的散列函数。分区边界可以是均匀间隔的，也可以是伪随机选择的（一致性哈希，consistent hashing）。

这种方法的好处是，相比于键范围分区，可以让数据分布更均匀，减少热点。

这种方法的坏处是，键不是按照顺序保存的，所以范围查询比较麻烦，需要查询所有的分区。

### 热点消除

热点是无法完全避免的，例如，在极端情况下，所有读写操作都是针对同一个键的，那所有请求都会被路由到同一个分区。

数据库无法自动消除这种热点，需要应用程序采取一些措施。例如，如果一个主键太火爆了，就在主键的末尾添加一个随机数，让数据存储到不同的分区中。读取时，需要从所有相应分区中读取并合并。

## 分区与次级索引

次级索引（secondary index）通常并不能唯一标识记录，而是用来搜索包含特定值的记录，例如：查找所有红色的车辆。

在基于主键进行键值分区后，如果要再对次级索引进行分区，有两种方式：

- 基于文档（document-based）的分区
- 基于关键词（term-based）的分区

### 基于文档的分区

如下所示，每个分区的次级索引是独立的，只覆盖该分区中的数据。写入数据时，只需要处理该数据对应的分区。读取数据时，需要查询所有分区并合并，称为分散/聚集（scatter/gather）。

文档分区索引也称为本地索引，它被广泛使用于MongoDB、Riak、Cassandra、ElasticSearch等数据库中。

![DistributedData SecondaryKeyDocumentBasedPartition](/assets/img/DDIA_DistributedData_SecondaryKeyDocumentBasedPartition.png)

### 基于关键词的分区

如下所示，关键词分区索引是一种全局索引，覆盖了所有分区的数据，只不过这个全局索引会被分区。和键值数据的分区一样，关键词分区可以根据关键词本身或其散列进行。

相比于文档分区，关键词分区的优点在于，读取时只需要向包含关键词的那个分区发出请求，效率更高。缺点在于，写入时需要更新索引所在的多个分区，比较复杂，并且速度比较慢。

在实践中，对关键词分区索引的更新通常是异步的。

![DistributedData SecondaryKeyTermBasedPartition](/assets/img/DDIA_DistributedData_SecondaryKeyTermBasedPartition.png)

## 分区再平衡