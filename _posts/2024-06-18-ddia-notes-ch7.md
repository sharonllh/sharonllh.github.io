---
layout: post
title: DDIA阅读笔记(7)：分布式数据系统的事务
date: 2024-06-18 +0800
tags: [系统设计, DDIA]
categories: [系统设计]
---

## 事务的概念

事务（transaction）是应用程序把多个读写操作组合成一个逻辑单元的方式。

### ACID的含义

事务提供的安全保证，可以用ACID来描述。

#### A：原子性（Atomicity）

原子性的含义：当事务中有多个写操作，进行到一半时出现故障，数据库能够中止事务，并且丢弃该事务的所有写入。

原子性提供了all-or-nothing的保证，使应用程序不用担心部分失败的情况。

#### C：一致性（Consistency）

一致性的含义：对数据的一组特定约束必须始终成立，即不变式（invariants）。

一致性取决于应用程序，而不是数据库。应用程序需要理解不变式，并正确定义事务。

#### I：隔离性（Isolation）

隔离性的含义：同时执行的事务是互相隔离的，不会互相干扰。如果一个事务进行多个写操作，另一个事务要么看到全部写入的结果，要么什么也看不到。

隔离性可以理解为可串行化（serializability），即当多个事务并发运行时，结果与它们串行运行是一样的。

#### D：持久性（Durability）

持久性的含义：一旦事务成功完成，即使数据库崩溃或者硬件故障了，写入的数据也不会丢失。

在单节点数据库中，持久性通过以下方式来实现：
- 把数据写入非易失性存储设备，如硬盘、SSD。
- 同时把数据写入预写日志，这样可以在数据库崩溃时进行恢复。

在分布式数据库中，持久性的实现方式：等数据被成功复制到多个节点，才报告事务成功。

完美的持久性是不存在。如果所有硬盘和备份都被销毁了，数据肯定就丢失了。

### 单对象和多对象操作

一般数据库对单个节点的单个对象都提供事务保证。有些数据库还会提供更复杂的原子操作，例如：
- 原子自增：在并发的情况下，每次把值增加1。
- 比较和设置（CAS，compare-and-set）：只有在值没有被其他并发修改过时，才执行写操作。

多对象操作也需要事务，例如：
- 在关系数据库中，一个表中的行具有对另一个表中的行的外键引用，更改时需要保证外键正确。
- 在文档数据库中，一个字段可能同时存储在多个文档中，更新该字段时需要保证多个文档中的值都被更新。
- 如果数据库中有次级索引，更新数据时需要同时更新次级索引。

许多分布式数据库没有多对象事务，因为实现比较困难，并且可能会影响可用性。