---
layout: post
title: DDIA阅读笔记(8)：分布式数据系统的麻烦
date: 2024-06-25 +0800
tags: [系统设计, DDIA]
categories: [系统设计]
---

## 不可靠的网络

互联网和以太网中的大多数内部网络是异步分组网络，一个节点向另一个节点发送消息时，网络不能保证是否到达、什么时候到达。因此，发送请求时，需要设置超时（timeout），在一段时候后放弃等待。

网络故障是很常见的，软件需要有能力应对网络故障，并从中恢复。为了保证软件的这方面能力，可以采用Chaos Monkey的想法，有意识地触发网络问题并测试系统响应。

### 检测节点故障

许多系统需要自动检测节点故障，例如：
- 负载均衡器需要停止向已经死亡的节点转发请求。
- 在单主复制的数据库中，如果主库失效，需要将从库之一升级成主库。

在以下情况中，可以明确判断节点发生故障了：
- 如果可以连接到运行节点的机器，但没有进程在监听目标端口，那么操作系统会发送FIN或RST来关闭并重用TCP连接。
- 如果节点进程崩溃，但操作系统仍然在运行，那么可以通过脚本通知其他节点关于该崩溃的信息，从而让另一个节点快速接管。
- 在数据中心网络交换机的管理界面，可以检测硬件级别的链路故障，如远程机器是否关闭电源等。
- 如果路由器确认要连接的IP地址不可用，可能会返回ICMP目标不可达数据包。

在其他情况下，可能没有这么明确的信号。这时候检测故障可以采取这样的办法：设置一个超时和重试次数，如果连续几次都无法在超时时间内收到响应，就认为节点已经死亡。

### 设置超时

首先，超时不能设置得太长。如果超时太长了，那么很长时间才能知道一个节点故障了，这段时间内用户必须等待。

其次，超时不能设置得太短。如果超时太短了，固然可以更快检测到故障，但是也有可能会误判。
- 如果一个节点没有死亡，还在执行发邮件等操作，却被误判为故障，由另一个节点接管。那么，发邮件这个操作会被执行两次。
- 如果一个节点没有死亡，只是处于高负载的状态，却被误判为故障，由另一个节点接管。那么，转移过来的负载可能会导致其他节点出现级联失效。

如果网络的最大延迟为`d`，服务器的最大处理时间为`r`，那么可以设置超时为`2d + r`。可惜在现实中，异步网络具有无限延迟，服务器也不保证在一定时间内处理请求。

可以通过实验方法选择超时：在较长的一段时间内，在多台机器上测量响应时间的分布，基于这个数据选择超时。另外，超时可以是不固定的，而是根据响应时间的变化自动调整的。

## 不可靠的时钟

每台机器的时钟是由一个硬件设备决定的：石英晶体振荡器。由于这些设备不是完全准确的，所以每台机器都有自己的时间。

可以采用网络时间协议（NTP）来同步时钟。NTP服务器从精确的时间源（如GPS接收机）获取时间，然后每台机器可以根据一组服务器报告的时间来调整时钟。

### 单调钟和日历时钟

现代计算机至少有两种时钟：
- 日历时钟（time-of-day clock）
- 单调钟（monotonic clock）

#### 日历时钟

日历时钟是根据某个日历（通常是1970年1月1日午夜）返回的当前日期和时间。

日历时钟与NTP同步，从而使不同机器上的时间相同。如果本地时钟和NTP服务器相差较远，可能会被强制重置，有时候看上去好像时间往回跳了一样。

由于时间跳跃和忽略闰秒的原因，日历时钟不能用来测量elapsed time。

#### 单调钟

单调钟可能是计算机启动以来的纳秒数，或者类似的任意值。

单调钟的绝对值是没有意义的，可以用两个绝对值之间的差异来衡量持续时间。

NTP不能让单调钟跳转，只能调整单调钟向前走的频率。

单调钟没有时间跳跃，分辨率也很高（微秒级），所以可以用来测量elapsed time。

### 时钟同步和准确性

单调钟不需要同步，日历时钟需要NTP来同步。然而，即使有NTP同步，日历时钟也不一定是准确的，原因可能有：
- 时钟漂移：计算机中的石英钟不准确，运行速度偏快或偏慢。
- 如果计算机的时钟和NTP服务器的时钟相差较大，可能会拒绝同步，或者被强制重置。
- 某个节点可能会被NTP服务器的防火墙意外阻塞。
- 网络延迟会限制NTP同步的准确性。
- 某些NTP服务器可能是错误的。NTP客户端可以查询多个服务器并忽略异常值，从而避免设置错误的值。
- 系统可能没有考虑闰秒。
- 用户可能会故意把时钟调整为错误的值。

通过GPS接收机、精确时间协议（PTP）、仔细的部署和监测，可以实现很好的时钟精度。

### 依赖时钟同步


