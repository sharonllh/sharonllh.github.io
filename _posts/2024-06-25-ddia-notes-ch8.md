---
layout: post
title: DDIA阅读笔记(8)：分布式数据系统的麻烦
date: 2024-06-25 +0800
tags: [系统设计, DDIA]
categories: [系统设计]
---

## 不可靠的网络

互联网和以太网中的大多数内部网络是异步分组网络，一个节点向另一个节点发送消息时，网络不能保证是否到达、什么时候到达。因此，发送请求时，需要设置超时（timeout），在一段时候后放弃等待。

网络故障是很常见的，软件需要有能力应对网络故障，并从中恢复。为了保证软件的这方面能力，可以采用Chaos Monkey的想法，有意识地触发网络问题并测试系统响应。

### 检测节点故障

许多系统需要自动检测节点故障，例如：
- 负载均衡器需要停止向已经死亡的节点转发请求。
- 在单主复制的数据库中，如果主库失效，需要将从库之一升级成主库。

在以下情况中，可以明确判断节点发生故障了：
- 如果可以连接到运行节点的机器，但没有进程在监听目标端口，那么操作系统会发送FIN或RST来关闭并重用TCP连接。
- 如果节点进程崩溃，但操作系统仍然在运行，那么可以通过脚本通知其他节点关于该崩溃的信息，从而让另一个节点快速接管。
- 在数据中心网络交换机的管理界面，可以检测硬件级别的链路故障，如远程机器是否关闭电源等。
- 如果路由器确认要连接的IP地址不可用，可能会返回ICMP目标不可达数据包。

在其他情况下，可能没有这么明确的信号。可以重试几次，如果在超时时间内都没有收到响应，就认为节点已经死亡。

### 超时和无限延迟